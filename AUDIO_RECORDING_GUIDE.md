# ???????????????

## ??

???????? WebRTC ?????????????????????????????????

1. **??????**???????????
2. **?? AI ??**????????? AI ???????
3. **????????**??????? AI ????????????????

## ????

### 1. ????

????????? `startRecording()` ???

```swift
import RealtimeAPI
import AVFoundation

// ??????
let conversation = try Conversation()

// ??? API
try await conversation.connect(ephemeralKey: YOUR_EPHEMERAL_KEY)

// ????????
try conversation.startRecording()

// ????????
let documentsPath = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask)[0]
let userAudioURL = documentsPath.appendingPathComponent("user_audio.caf")
try conversation.startRecording(userAudioURL: userAudioURL)
```

### 2. ??????

```swift
// ????????
if conversation.isRecording {
    print("?????...")
}
```

### 3. ?????????????

```swift
// ????
conversation.stopRecording()

// ?????????????? AI ????
let outputURL = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask)[0]
    .appendingPathComponent("call_recording_\(Date().timeIntervalSince1970).m4a")

conversation.saveCallRecording(to: outputURL) { result in
    switch result {
    case .success(let url):
        print("????????: \(url)")
        // ????????????????
    case .failure(let error):
        print("????: \(error)")
    }
}
```

## ????

```swift
import SwiftUI
import RealtimeAPI

struct CallView: View {
    @State private var conversation = try! Conversation()
    @State private var isRecording = false
    @State private var recordingURL: URL?
    
    var body: some View {
        VStack {
            Text("???...")
            
            Button(action: {
                if isRecording {
                    stopAndSaveRecording()
                } else {
                    startRecording()
                }
            }) {
                Text(isRecording ? "????" : "????")
            }
        }
        .task {
            // ???????
            try? await conversation.connect(ephemeralKey: YOUR_EPHEMERAL_KEY)
            try? conversation.startRecording()
            isRecording = true
        }
    }
    
    func startRecording() {
        do {
            try conversation.startRecording()
            isRecording = true
        } catch {
            print("??????: \(error)")
        }
    }
    
    func stopAndSaveRecording() {
        conversation.stopRecording()
        isRecording = false
        
        // ????????
        let outputURL = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask)[0]
            .appendingPathComponent("call_\(UUID().uuidString).m4a")
        
        conversation.saveCallRecording(to: outputURL) { result in
            switch result {
            case .success(let url):
                recordingURL = url
                print("?????: \(url.path)")
                
                // ??????
                // 1. ??????
                // 2. ?????
                // 3. ??????
                
            case .failure(let error):
                print("????: \(error)")
            }
        }
    }
}
```

## ????

### ??????

- ?? `AudioRecorder` ??? `AVAudioEngine` ???????
- ?????PCM 16-bit, 24kHz, ????? OpenAI Realtime API ???
- ?????????

### AI ????

- ? `Conversation.entries` ????? AI ???????
- AI ?????? `responseOutputAudioDelta` ??
- ????????????????

### ????

- ?? `AVMutableComposition` ?????????
- ???????????? ? AI ?? ? ???? ? ...
- ????? M4A ????? iOS ???

## ????

### ??? AI ??

?????? AI ??????

```swift
let aiAudioData = conversation.extractAIAudioData()

// ?? AI ????
let aiAudioURL = documentsPath.appendingPathComponent("ai_audio.caf")
let format = AVAudioFormat(
    commonFormat: .pcmFormatInt16,
    sampleRate: 24000,
    channels: 1,
    interleaved: false
)!

for (index, audioData) in aiAudioData.enumerated() {
    let url = aiAudioURL.deletingLastPathComponent()
        .appendingPathComponent("ai_\(index).caf")
    
    if let buffer = AVAudioPCMBuffer.fromData(audioData, format: format),
       let audioFile = try? AVAudioFile(forWriting: url, settings: format.settings) {
        try? audioFile.write(from: buffer)
    }
}
```

### ???????

```swift
// ????
if let recorder = conversation.audioRecorder {
    recorder.pause()
}

// ????
try? recorder.resume()
```

## ????

1. **????**???????????
   ```swift
   await AVAudioApplication.requestRecordPermission()
   ```

2. **????**?
   - ?????CAF ???Core Audio Format?
   - ?????M4A ?????????

3. **????**?
   - AI ?????????????????
   - ???????????????

4. **????**?
   - ?????????????????
   - ?????????????

## ????

```swift
conversation.saveCallRecording(to: outputURL) { result in
    switch result {
    case .success(let url):
        // ????
        break
    case .failure(let error):
        if let convError = error as? ConversationError {
            switch convError {
            case .noUserAudioRecording:
                print("????????")
            default:
                print("????: \(convError)")
            }
        } else {
            print("????: \(error)")
        }
    }
}
```

## ??

??????
- ? ?????????
- ? ?? AI ???????
- ? ???????????????
- ? ????????????

???? AI ???????